---
title: "Basic Analyses in R"
author: "Daniel Albohn, Kayla Brown, & Yiming Qian"
date: "`r Sys.time()`"
output:
  html_document:
    theme: spacelab
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE)
options(width = 150, digits = 3)
```

# Load and preprocess data
First load the required packages for this walk through.

```{r packages}
pkg_list <- c("tidyverse", "psych", "ez", "rcompanion", "knitr", "car")
lapply(pkg_list, library, quietly = TRUE, character.only = TRUE)
```

**Optional package**
```{r optional-package}
# devtools::install_github("ropensci/skimr")
library("skimr")
```

The data set being used for this walk through is automatically loaded when `psych` is loaded.
You can examine what each of the columns represent by looking at the data set's help
page with `?sat.act`.

Next, just to get a snapshot of the data, we can use `head` and `str`. Notice that `gender` and
`education` are integer columns despite being categorical variables.

```{r head}
head(sat.act)
```

```{r str}
str(sat.act)
```

## Preprocessing integers into factors
Since some of the analyses we will be running require categorical variables, we first need to
preprocess some of the numeric columns into categories. Let's quickly add two columns
to the data set for factored versions of of `gender` and `education`.

```{r preprocess-data}
sat_act <- sat.act %>%
  # mutate(., gender_fac = ifelse(gender == 1, "male", "female") %>%
  mutate(.,
    gender_fac = case_when(gender == 1 ~ "male",
                           gender == 2 ~ "female"),
    education_fac = case_when(education == 0 ~ "none",
                              education == 1 ~ "some_hs",
                              education == 2 ~ "high_school",
                              education == 3 ~ "some_college",
                              education == 4 ~ "college",
                              education == 5 ~ "graduate")
  )
  
```

# Describe data
Before analysis, we can obtain descriptive statistics quickly by utilizing the `describe()` function
in the `psych` package.

```{r describe-1}
describe(sat_act)
```

The `describe()` function also allows to descriptive statistics by a grouping variable
using the partner function `describeBy()`. If we wanted to get descriptive statistics
by `gender_fac` we simply pass that column to an argument.

```{r describe-2}
describeBy(sat_act, group = c("gender_fac"))
```

We can add multiple grouping variables in the same manner.

```{r describe-3}
describeBy(sat_act, group = c("gender_fac", "education_fac"))
```

**Optional**
While `describe` is useful for quick glimpses at the data, it does not always play
nicely with the `tidyverse`. If you wanted to stick with a more "pure" `tidyverse`
approach to descriptive statistics, you can use `skimr`.

```{r}
sat_act %>% 
  skimr::skim(.)
```

While `skim()` doesn't provide as much descriptive detail as `describe`, it
does provide the basics, and a useful visual representation of the data.

Similarly, for obtaining descriptives by grouping variables you can utilize the
`group_by()` function.

```{r}
sat_act %>% 
  group_by(., gender_fac) %>% 
  skimr::skim(.)
```

```{r}
sat_act %>% 
  group_by(., education_fac) %>% 
  skimr::skim(.)
```

# Chi-squared
Suppose we wanted to see if number of males or females differed by education level.
One way to accomplish this is to perform a chi-squared test of independence.
In R, the `chisq.test()` function expects a contingency table in order to produce
the appropriate statistic. A contingency table provides count data by groups.

```{r table}
edu_gender_table <- table(sat_act$education_fac, sat_act$gender_fac)
print(edu_gender_table)
```

Next, we simply pass the contingency table to the `chisq.test()` function.

```{r chi-squared}
chi_test <- chisq.test(edu_gender_table)
chi_test
```

It appears as though the two variables are not independent. We will examine
the pairwise comparisons in a moment to get a better idea of which variables
are driving these results.

We can get the observed, expected, and residuals from the saved object.

```{r chi-observed}
chi_test$observed
```

```{r chi-expected}
chi_test$expected
```

We could also get the chi-squared statistic from the table `summary()`

```{r chi-summary}
summary(edu_gender_table)
```

## Pairwise comparisons
If we want to compare each level with the other in our contingency table
we can computed those with pairwise comparisons using `rcompanion`.

```{r rcomp-pairwise}
rcompanion::pairwiseNominalIndependence(edu_gender_table,
                                        fisher = FALSE,
                                        gtest = FALSE,
                                        correct = "holm")
```

or compare both groups between each other with `pairwise.t.test`. Note that this
method requires that original, numeric data.

```{r broom-pairwise}
pairwise <- pairwise.t.test(sat_act$gender, sat_act$education, p.adjust.method = "holm")
broom::tidy(pairwise)
```

# Correlations
Moving beyond categorical variables, we next test the relationship between numeric values using
simple correlation. Correlation is done using the `cor()` function.

Suppose we want to see if the ACT scores increase with age.

```{r cor-cov}
# Covariance
# cov(sat_act$age, sat_act$ACT)

# Correlation
cor(sat_act$age, sat_act$ACT)
```

A small correlation, but no test of significance. To obtain significance values, you
must pass your data to `cor.test()`. Note that this can be done by passing `x` and `y`
or using the formula method (which will be used for linear models).

```{r}
# Default method
# cor.test(sat_act$age, sat_act$ACT)

# Formula method
cor.test(~ sat_act$age + sat_act$ACT, data = sat_act)
```

You can also pass a dataframe of values to the `cor` function to get a simple
correlation matrix (a la SPSS).

```{r}
cor(sat_act[c("age","ACT","SATV","SATQ")], use = "pairwise.complete.obs")
```

# Linear models

# ANOVA
The overall goal is to give you a very quick introduction to conducting one-way ANOVA and two-way ANOVA in R.

Analysis of variance (ANOVA) provides a statistical test of whether two or more population means are equal. It is based on the law of total variance, where the observed variance in particular variable is partitioned into components attributable to differnt sources of variation. When the population means are equal, the differences among the group means reflect the operation of experimental error alone (within-groups deviation). When the population means are not equal, the differences among the group means will reflect the operation of both experimental error (within-groups deviation) and treatment effects (between-group deviation). In ANOVA, we produce the ratio of: 

$$\frac{S^2_{treatment} + S^2_{error}}{S^2_{error}}$$

Variance = (sum of square deviation from the mean)/(degrees of freedom)=SS/df
Sum of Squares: 
$$SS_{Total}= SS_{between}+SS_{within}$$
$$\sum(Y_{i.j}-\bar{Y_T})= \sum(\bar{Y_{ai}-\bar{Y_T})+\sum(Y_{i.j}-\bar{Y_{ai})$$
Degrees of freedom:
$$df_{Total}= df_{between}+df_{within}$$

***
### For a single factor

The one-way ANOVA is an extension of independent two-sample t-test for comparing means in a situation where there are two groups or more than two groups. In one-way ANOVA, the data is organized into several groups base on one single grouping variable (also called factor variable).

#### One-way ANOVA Assumptions: 
    - Independence of observations
    - Normality (normal distributions of the residuals)
    - Homoscendasticity (equal variances for all groups)

1. Normality
``` {r test-assumption-2}
df<-ToothGrowth
df$dose <- factor(df$dose, 
                  levels = c(0.5, 1, 2),
                  labels = c("D0.5", "D1", "D2"))
kruskal.test(len ~ supp, data = df)
```

From the output above we can see that the p-value is not less than the significance level of 0.05. 

2. Homogeneity of variances
``` {r test-assumption-3}
leveneTest(len ~ supp, data = df)
```

From the output above we can see that the p-value is not less than the significance level of 0.05. This means that there is no evidence to suggest that the variance across groups is statistically significantly different. Therefore, we can assume the homogeneity of variances in the different treatment groups.

``` {r one-way-ANOVA-demonstration-1}
table(df$supp) # there are three levels
group_by(df, supp) %>%
  summarise(
    count = n(),
    mean = mean(len, na.rm = TRUE),
    sd = sd(len, na.rm = TRUE)
  )
```

``` {r one-way-ANOVA-demonstration-2}
# Compute the analysis of variance
res.aov <- aov(len ~ supp, data = df)
# Summary of the analysis
summary(res.aov)
```
As the p-value is more than the significance level 0.05, we can conclude that there are no significant differences between the groups.

#### Box plots
Plot weight by group and color by group
``` {r one-way-ANOVA-visualization-1}
ggplot(df, aes(x=supp, y=len)) + 
  geom_boxplot(outlier.colour="red", outlier.shape=8,outlier.size=4) +
  geom_jitter(shape=16, position=position_jitter(0.2))

```

#### Check the homogeneity of variance assumption
``` {r one-way-ANOVA-visualization-2}
plot(res.aov, 1)
```
In the plot below, there is no evident relationships between residuals and fitted values (the mean of each groups), which is good. Points 23, 26 are detected as outliers, which can severely affect normality and homogeneity of variance. It can be useful to remove outliers to meet the test assumptions.

#### Check the normality assumption
``` {r one-way-ANOVA-visualization-3}
plot(res.aov, 2)
```
QQ-plot is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

#### Multiple pairwise-comparison between the means of groups
In one-way ANOVA test, a significant p-value indicates that some of the group means are different, but we donâ€™t know which pairs of groups are different. Itâ€™s possible to perform multiple pairwise-comparison, to determine if the mean difference between specific pairs of group are statistically significant. 
Example: Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) 

``` {r one-way-ANOVA-post-hoc}
TukeyHSD(res.aov)
```
diff: difference between means of the two groups
lwr, upr: the lower and the upper end point of the confidence interval at 95% (default)
p adj: p-value after adjustment for the multiple comparisons.

***
### For two factors

Two-way ANOVA test is used to evaluate simultaneously the effect of two grouping variables (A and B) on a response variable. The number of level may vary in each factor.

#### Two-way ANOVA test Assumptions:
1. There is no difference in the means of factor A
2. There is no difference in the means of factor B
3. There is no interaction between factors A and B
4. Normality (normal distributions of the residuals )
5. Homoscendasticity (equal variances for all groups)
The alternative hypothesis for cases 1 and 2 is: the means are not equal.
The alternative hypothesis for case 3 is: there is an interaction between A and B.

``` {r two-way-ANOVA-demonstration-1}
table(df$supp, df$dose)
group_by(df, supp, dose) %>%
  summarise(
    count = n(),
    mean = mean(len, na.rm = TRUE),
    sd = sd(len, na.rm = TRUE)
  )
```
In two-way ANOVA, we assume the sample sizes within cells are equal. If not, the ANOVA test should be handled differently (Type-III sums of squares).

#### We want to know if tooth length depends on supp and dose.
``` {r two-way-ANOVA-demonstration-2}
res.aov2 <- aov(len ~ supp + dose, data = df)
summary(res.aov2)
```
From the ANOVA table we can conclude that both supp and dose are statistically significant, highlighted with *. Dose is the most significant factor variable. These results would lead us to believe that changing delivery methods (supp) or the dose of vitamin C, will impact significantly the mean tooth length.

#### Note the above fitted model is called additive model. It makes an assumption that the two factor variables are independent. If you think that these two variables might interact to create an synergistic effect, replace the plus symbol (+) by an asterisk (*), as follow.
``` {r two-way-ANOVA-demonstration-3}
res.aov3 <- aov(len ~ supp * dose, data = df)
summary(res.aov3)
```
It can be seen that the two main effects (supp and dose) are statistically significant, as well as their interaction.

#### Line plots with multiple groups
Plot tooth length ("len") by groups ("dose")
Color box plot by a second group: "supp"
``` {r two-way-ANOVA-visualization-1}
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}
df3 <- data_summary(df, varname="len", 
                    groupnames=c("supp", "dose"))
ggplot(df3, aes(x=dose, y=len, group=supp, color=supp)) + 
    geom_errorbar(aes(ymin=len-sd, ymax=len+sd), width=.1, 
    position=position_dodge(0.05)) +
    geom_line() + geom_point()+
   scale_color_brewer(palette="Paired")+theme_minimal()
```

#### Multiple pairwise-comparison between the means of groups
It is to determine if the mean difference between specific pairs of group are statistically significant.
``` {r two-way-ANOVA-post-hoc}
TukeyHSD(res.aov3, which = "dose")
```

### Alternative: 

t-test: comparing means between two groups in a sample (t.test function)
Linear regression: comparing one or more factors in a sample (lm or lmer function)

# Hands on practice: data analyses
For this hands on practice, load the `spi` data set from the `psych` package.

1. Check the help file, structure, and first few observations of the data

```{r}

```

2. Change the integer categorical variables to factors by cross-referencing
the help page and filling in the pipeline below (note when knitting this
document, you may want to change `eval` to `TRUE` once you complete this
exercise)

```{r eval = FALSE}
spi <- spi %>%
  mutate(.,
    sex_fac = case_when(),
    health_fac = case_when(),
    education_fac = case_when(),
    smoke_fac = case_when(),
    exer_fac = case_when()
  )
```

## Descriptives and Chi-squared

1. Use either `describe()` or `skim()` to describe the data by each categorical
variable

```{r}

```


2. Describe the data by both categorical variables at once

```{r}

```


3. Perform a chi-squared test assessing whether there is a differences in smoking
by education level

```{r}

```

## Correlation

1. Get the covariance and correlation matrix for the relationship between
three numeric values of your choosing

```{r}

```

2. Perform a test of significance on two of the variables selected above

```{r}

```

## Linear models

## ANOVAs





